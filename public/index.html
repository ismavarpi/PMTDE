<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PMTDE</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <style>
    th {
      background-color: #f5f5f5;
    }
  </style>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@mui/material@5.15.8/umd/material-ui.development.js" crossorigin></script>
  <script src="https://unpkg.com/@emotion/react@11/umd/emotion-react.umd.min.js" crossorigin></script>
  <script src="https://unpkg.com/@emotion/styled@11/umd/emotion-styled.umd.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js" crossorigin></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const {
      AppBar,
      Toolbar,
      Typography,
      IconButton,
      Button,
      Box,
      Tabs,
      Tab,
      Dialog,
      DialogTitle,
      DialogContent,
      TextField,
      DialogActions,
      Table,
      TableHead,
      TableRow,
      TableCell,
      TableBody,
      TableSortLabel,
      Card,
      CardContent,
      Autocomplete,
      Tooltip
    } = MaterialUI;

    const formatDate = () => {
      const d = new Date();
      const pad = (n) => n.toString().padStart(2, '0');
      return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())} ${pad(d.getHours())}${pad(d.getMinutes())}`;
    };

    const normalize = (s) =>
      s
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');

    function useProcessing() {
      const [busy, setBusy] = React.useState(false);
      const [seconds, setSeconds] = React.useState(0);

      const perform = async (fn) => {
        setBusy(true);
        const start = Date.now();
        const interval = setInterval(() => {
          const s = Math.floor((Date.now() - start) / 1000);
          if (s >= 1) setSeconds(s);
        }, 1000);
        try {
          await fn();
        } finally {
          clearInterval(interval);
          setSeconds(0);
          setBusy(false);
        }
      };

      return { busy, seconds, perform };
    }

    const ProcessingBanner = ({ seconds }) => {
      if (!seconds) return null;
      return (
        <Box sx={{ position: 'fixed', top: 0, width: '100%', textAlign: 'center', bgcolor: 'warning.main', p: 1 }}>
          {`Procesando... ${seconds} seg`}
        </Box>
      );
    };

    function UsuariosManager({ usuarios, setUsuarios }) {
      const [dialogOpen, setDialogOpen] = React.useState(false);
      const [current, setCurrent] = React.useState({ nombre: '', apellidos: '', email: '' });
      const [view, setView] = React.useState('table');
      const [filterOpen, setFilterOpen] = React.useState(false);
      const [search, setSearch] = React.useState('');
      const [sortField, setSortField] = React.useState('nombre');
      const [sortDir, setSortDir] = React.useState('asc');
      const { busy, seconds, perform } = useProcessing();

      const openNew = () => {
        setCurrent({ nombre: '', apellidos: '', email: '' });
        setDialogOpen(true);
      };

      const openEdit = (u) => {
        setCurrent(u);
        setDialogOpen(true);
      };

      const handleSave = async () => {
        await perform(
          () =>
            new Promise((res) =>
              setTimeout(() => {
                setUsuarios((prev) => {
                  const exists = prev.find((p) => p.email === current.email);
                  if (exists) {
                    return prev.map((p) => (p.email === current.email ? current : p));
                  }
                  return [...prev, { ...current }];
                });
                setDialogOpen(false);
                res();
              }, 1500)
            )
        );
      };

      const handleDelete = (email) => {
        if (!window.confirm('¿Eliminar usuario?')) return;
        perform(
          () =>
            new Promise((res) =>
              setTimeout(() => {
                setUsuarios((prev) => prev.filter((u) => u.email !== email));
                res();
              }, 1500)
            )
        );
      };

      const filtered = usuarios
        .filter((u) => {
          const txt = normalize(`${u.nombre} ${u.apellidos} ${u.email}`);
          return txt.includes(normalize(search));
        })
        .sort((a, b) => {
          const valA = a[sortField] || '';
          const valB = b[sortField] || '';
          if (valA < valB) return sortDir === 'asc' ? -1 : 1;
          if (valA > valB) return sortDir === 'asc' ? 1 : -1;
          return 0;
        });

      const exportCSV = () => {
        const header = ['Nombre', 'Apellidos', 'Email'];
        const rows = filtered.map((u) => [u.nombre, u.apellidos, u.email]);
        let csv = header.join(';') + '\n';
        rows.forEach((r) => {
          csv += r.join(';') + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${formatDate()} Usuarios.csv`;
        link.click();
      };

      const exportPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Usuarios', 10, 10);
        let y = 20;
        filtered.forEach((u) => {
          doc.text(`${u.nombre} ${u.apellidos} - ${u.email}`, 10, y);
          y += 10;
        });
        doc.save(`${formatDate()} Usuarios.pdf`);
      };

      const resetFilters = () => {
        setSearch('');
      };

      const handleSort = (field) => {
        const isAsc = sortField === field && sortDir === 'asc';
        setSortField(field);
        setSortDir(isAsc ? 'desc' : 'asc');
      };

      return (
        <Box sx={{ p: 2 }}>
          <ProcessingBanner seconds={seconds} />
          <Box sx={{ display: 'flex', gap: 1, mb: 1 }}>
            <Tooltip title="Añadir">
              <IconButton onClick={openNew} disabled={busy}>
                <span className="material-symbols-outlined">add</span>
              </IconButton>
            </Tooltip>
            <Tooltip title="Exportar CSV">
              <IconButton onClick={exportCSV} disabled={busy}>
                <span className="material-symbols-outlined">download</span>
              </IconButton>
            </Tooltip>
            <Tooltip title="Exportar PDF">
              <IconButton onClick={exportPDF} disabled={busy}>
                <span className="material-symbols-outlined">picture_as_pdf</span>
              </IconButton>
            </Tooltip>
            <Tooltip title="Filtrar">
              <IconButton onClick={() => setFilterOpen((o) => !o)} disabled={busy}>
                <span className="material-symbols-outlined">filter_list</span>
              </IconButton>
            </Tooltip>
            <Tooltip title={view === 'table' ? 'Ver como cards' : 'Ver como tabla'}>
              <IconButton onClick={() => setView(view === 'table' ? 'cards' : 'table')} disabled={busy}>
                <span className="material-symbols-outlined">{view === 'table' ? 'dashboard' : 'table_rows'}</span>
              </IconButton>
            </Tooltip>
          </Box>

          {filterOpen && (
            <Box sx={{ mb: 2, display: 'flex', gap: 2, alignItems: 'center' }}>
              <TextField
                label="Buscar"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
              />
              <Button onClick={resetFilters}>Resetear</Button>
            </Box>
          )}

          {view === 'table' ? (
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>
                    <TableSortLabel
                      active={sortField === 'nombre'}
                      direction={sortDir}
                      onClick={() => handleSort('nombre')}
                    >
                      Nombre
                    </TableSortLabel>
                  </TableCell>
                  <TableCell>
                    <TableSortLabel
                      active={sortField === 'apellidos'}
                      direction={sortDir}
                      onClick={() => handleSort('apellidos')}
                    >
                      Apellidos
                    </TableSortLabel>
                  </TableCell>
                  <TableCell>
                    <TableSortLabel
                      active={sortField === 'email'}
                      direction={sortDir}
                      onClick={() => handleSort('email')}
                    >
                      Email
                    </TableSortLabel>
                  </TableCell>
                  <TableCell>Acciones</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {filtered.map((u) => (
                  <TableRow key={u.email}>
                    <TableCell>{u.nombre}</TableCell>
                    <TableCell>{u.apellidos}</TableCell>
                    <TableCell>{u.email}</TableCell>
                    <TableCell>
                      <Tooltip title="Editar">
                        <IconButton onClick={() => openEdit(u)} disabled={busy}>
                          <span className="material-symbols-outlined">edit</span>
                        </IconButton>
                      </Tooltip>
                      <Tooltip title="Eliminar">
                        <IconButton onClick={() => handleDelete(u.email)} disabled={busy}>
                          <span className="material-symbols-outlined">delete</span>
                        </IconButton>
                      </Tooltip>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          ) : (
            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 2 }}>
              {filtered.map((u) => (
                <Card key={u.email} sx={{ width: 250 }}>
                  <CardContent>
                    <Typography variant="h6">{u.nombre} {u.apellidos}</Typography>
                    <Typography variant="body2">{u.email}</Typography>
                    <Box sx={{ mt: 1 }}>
                      <Tooltip title="Editar">
                        <IconButton onClick={() => openEdit(u)} disabled={busy}>
                          <span className="material-symbols-outlined">edit</span>
                        </IconButton>
                      </Tooltip>
                      <Tooltip title="Eliminar">
                        <IconButton onClick={() => handleDelete(u.email)} disabled={busy}>
                          <span className="material-symbols-outlined">delete</span>
                        </IconButton>
                      </Tooltip>
                    </Box>
                  </CardContent>
                </Card>
              ))}
            </Box>
          )}

          <Dialog open={dialogOpen} onClose={() => setDialogOpen(false)}>
            <DialogTitle>{current.email ? 'Editar usuario' : 'Nuevo usuario'}</DialogTitle>
            <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                label="Nombre*"
                value={current.nombre}
                onChange={(e) => setCurrent({ ...current, nombre: e.target.value })}
              />
              <TextField
                label="Apellidos*"
                value={current.apellidos}
                onChange={(e) => setCurrent({ ...current, apellidos: e.target.value })}
              />
              <TextField
                label="Email*"
                value={current.email}
                onChange={(e) => setCurrent({ ...current, email: e.target.value })}
              />
            </DialogContent>
            <DialogActions>
              <Button onClick={() => setDialogOpen(false)} disabled={busy}>Cancelar</Button>
              <Button onClick={handleSave} disabled={busy}>Guardar</Button>
            </DialogActions>
          </Dialog>
        </Box>
      );
    }

    function ProgramasManager({ usuarios }) {
      const [programas, setProgramas] = React.useState([]);
      const [dialogOpen, setDialogOpen] = React.useState(false);
      const [current, setCurrent] = React.useState({ nombre: '', propietario: null });
      const [view, setView] = React.useState('table');
      const [filterOpen, setFilterOpen] = React.useState(false);
      const [search, setSearch] = React.useState('');
      const [ownerFilter, setOwnerFilter] = React.useState([]);
      const [sortField, setSortField] = React.useState('nombre');
      const [sortDir, setSortDir] = React.useState('asc');
      const { busy, seconds, perform } = useProcessing();

      const openNew = () => {
        setCurrent({ nombre: '', propietario: null });
        setDialogOpen(true);
      };

      const openEdit = (p) => {
        setCurrent(p);
        setDialogOpen(true);
      };

      const handleSave = async () => {
        await perform(
          () =>
            new Promise((res) =>
              setTimeout(() => {
                setProgramas((prev) => {
                  const exists = prev.find((x) => x.id === current.id);
                  if (exists) {
                    return prev.map((x) => (x.id === current.id ? current : x));
                  }
                  return [...prev, { ...current, id: Date.now() }];
                });
                setDialogOpen(false);
                res();
              }, 1500)
            )
        );
      };

      const handleDelete = (id) => {
        if (!window.confirm('¿Eliminar PMTDE?')) return;
        perform(
          () =>
            new Promise((res) =>
              setTimeout(() => {
                setProgramas((prev) => prev.filter((p) => p.id !== id));
                res();
              }, 1500)
            )
        );
      };

      const filtered = programas
        .filter((p) => {
          const txt = normalize(`${p.nombre} ${p.propietario ? p.propietario.nombre + ' ' + p.propietario.apellidos : ''}`);
          const searchMatch = txt.includes(normalize(search));
          const ownerMatch = ownerFilter.length
            ? ownerFilter.some((o) => o.email === (p.propietario && p.propietario.email))
            : true;
          return searchMatch && ownerMatch;
        })
        .sort((a, b) => {
          const valA = a[sortField] || '';
          const valB = b[sortField] || '';
          if (valA < valB) return sortDir === 'asc' ? -1 : 1;
          if (valA > valB) return sortDir === 'asc' ? 1 : -1;
          return 0;
        });

      const exportCSV = () => {
        const header = ['Nombre', 'Propietario'];
        const rows = filtered.map((p) => [p.nombre, p.propietario ? p.propietario.email : '']);
        let csv = header.join(';') + '\n';
        rows.forEach((r) => {
          csv += r.join(';') + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${formatDate()} PMTDE.csv`;
        link.click();
      };

      const exportPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text('Programas Marco', 10, 10);
        let y = 20;
        filtered.forEach((p) => {
          doc.text(`${p.nombre} - ${p.propietario ? p.propietario.email : ''}`, 10, y);
          y += 10;
        });
        doc.save(`${formatDate()} PMTDE.pdf`);
      };

      const resetFilters = () => {
        setSearch('');
        setOwnerFilter([]);
      };

      const handleSort = (field) => {
        const isAsc = sortField === field && sortDir === 'asc';
        setSortField(field);
        setSortDir(isAsc ? 'desc' : 'asc');
      };

      return (
        <Box sx={{ p: 2 }}>
          <ProcessingBanner seconds={seconds} />
          <Box sx={{ display: 'flex', gap: 1, mb: 1 }}>
            <Tooltip title="Añadir">
              <IconButton onClick={openNew} disabled={busy}>
                <span className="material-symbols-outlined">add</span>
              </IconButton>
            </Tooltip>
            <Tooltip title="Exportar CSV">
              <IconButton onClick={exportCSV} disabled={busy}>
                <span className="material-symbols-outlined">download</span>
              </IconButton>
            </Tooltip>
            <Tooltip title="Exportar PDF">
              <IconButton onClick={exportPDF} disabled={busy}>
                <span className="material-symbols-outlined">picture_as_pdf</span>
              </IconButton>
            </Tooltip>
            <Tooltip title="Filtrar">
              <IconButton onClick={() => setFilterOpen((o) => !o)} disabled={busy}>
                <span className="material-symbols-outlined">filter_list</span>
              </IconButton>
            </Tooltip>
            <Tooltip title={view === 'table' ? 'Ver como cards' : 'Ver como tabla'}>
              <IconButton onClick={() => setView(view === 'table' ? 'cards' : 'table')} disabled={busy}>
                <span className="material-symbols-outlined">{view === 'table' ? 'dashboard' : 'table_rows'}</span>
              </IconButton>
            </Tooltip>
          </Box>

          {filterOpen && (
            <Box sx={{ mb: 2, display: 'flex', gap: 2, alignItems: 'center' }}>
              <TextField label="Buscar" value={search} onChange={(e) => setSearch(e.target.value)} />
              <Autocomplete
                multiple
                options={usuarios}
                getOptionLabel={(u) => `${u.nombre} ${u.apellidos}`}
                value={ownerFilter}
                onChange={(e, val) => setOwnerFilter(val)}
                renderInput={(params) => <TextField {...params} label="Propietario" />}
              />
              <Button onClick={resetFilters}>Resetear</Button>
            </Box>
          )}

          {view === 'table' ? (
            <Table>
              <TableHead>
                <TableRow>
                  <TableCell>
                    <TableSortLabel
                      active={sortField === 'nombre'}
                      direction={sortDir}
                      onClick={() => handleSort('nombre')}
                    >
                      Nombre del PMTDE
                    </TableSortLabel>
                  </TableCell>
                  <TableCell>
                    <TableSortLabel
                      active={sortField === 'propietario'}
                      direction={sortDir}
                      onClick={() => handleSort('propietario')}
                    >
                      Propietario
                    </TableSortLabel>
                  </TableCell>
                  <TableCell>Acciones</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {filtered.map((p) => (
                  <TableRow key={p.id}>
                    <TableCell>{p.nombre}</TableCell>
                    <TableCell>{p.propietario ? `${p.propietario.nombre} ${p.propietario.apellidos}` : ''}</TableCell>
                    <TableCell>
                      <Tooltip title="Editar">
                        <IconButton onClick={() => openEdit(p)} disabled={busy}>
                          <span className="material-symbols-outlined">edit</span>
                        </IconButton>
                      </Tooltip>
                      <Tooltip title="Eliminar">
                        <IconButton onClick={() => handleDelete(p.id)} disabled={busy}>
                          <span className="material-symbols-outlined">delete</span>
                        </IconButton>
                      </Tooltip>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          ) : (
            <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 2 }}>
              {filtered.map((p) => (
                <Card key={p.id} sx={{ width: 250 }}>
                  <CardContent>
                    <Typography variant="h6">{p.nombre}</Typography>
                    <Typography variant="body2">
                      {p.propietario ? `${p.propietario.nombre} ${p.propietario.apellidos}` : ''}
                    </Typography>
                    <Box sx={{ mt: 1 }}>
                      <Tooltip title="Editar">
                        <IconButton onClick={() => openEdit(p)} disabled={busy}>
                          <span className="material-symbols-outlined">edit</span>
                        </IconButton>
                      </Tooltip>
                      <Tooltip title="Eliminar">
                        <IconButton onClick={() => handleDelete(p.id)} disabled={busy}>
                          <span className="material-symbols-outlined">delete</span>
                        </IconButton>
                      </Tooltip>
                    </Box>
                  </CardContent>
                </Card>
              ))}
            </Box>
          )}

          <Dialog open={dialogOpen} onClose={() => setDialogOpen(false)}>
            <DialogTitle>{current.id ? 'Editar PMTDE' : 'Nuevo PMTDE'}</DialogTitle>
            <DialogContent sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
              <TextField
                label="Nombre del PMTDE*"
                value={current.nombre}
                onChange={(e) => setCurrent({ ...current, nombre: e.target.value })}
              />
              <Autocomplete
                options={usuarios}
                getOptionLabel={(u) => `${u.nombre} ${u.apellidos} (${u.email})`}
                value={current.propietario}
                onChange={(e, val) => setCurrent({ ...current, propietario: val })}
                renderInput={(params) => <TextField {...params} label="Propietario*" />}
              />
            </DialogContent>
            <DialogActions>
              <Button onClick={() => setDialogOpen(false)} disabled={busy}>Cancelar</Button>
              <Button onClick={handleSave} disabled={busy}>Guardar</Button>
            </DialogActions>
          </Dialog>
        </Box>
      );
    }

    function AdminPanel({ usuarios, setUsuarios }) {
      const [tab, setTab] = React.useState(0);
      return (
        <Box>
          <Tabs value={tab} onChange={(e, v) => setTab(v)}>
            <Tab label="Programas Marco" />
            <Tab label="Usuarios" />
          </Tabs>
          {tab === 0 && <ProgramasManager usuarios={usuarios} />}
          {tab === 1 && <UsuariosManager usuarios={usuarios} setUsuarios={setUsuarios} />}
        </Box>
      );
    }

    function App() {
      const [view, setView] = React.useState('home');
      const [usuarios, setUsuarios] = React.useState([]);

      return (
        <Box>
          <AppBar position="static">
            <Toolbar>
              <Typography variant="h6" sx={{ flexGrow: 1 }}>
                PMTDE
              </Typography>
              <IconButton color="inherit" onClick={() => setView('admin')}>
                <span className="material-symbols-outlined">settings</span>
              </IconButton>
            </Toolbar>
          </AppBar>
          {view === 'admin' ? (
            <AdminPanel usuarios={usuarios} setUsuarios={setUsuarios} />
          ) : (
            <Box sx={{ p: 2 }}>Bienvenido</Box>
          )}
        </Box>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>

